//from system
import { PersistenceV2, promptAction, router } from '@kit.ArkUI';
import i18n from '@ohos.i18n'

//from myself
import { calculateTotalAssets, } from "../utils/moneyCount"
import { RecordItem, RecordsData } from '../models/recordItemReference';
import { MultiCurrencyComposition } from '../components/multiCurrency';
import { UserSetting } from "../models/userSetting"
import { WeeklyChart, calculateWeeklyData } from "../components/charts/weeklyChart"
import { ratesStatus } from "../components/RatesStatus"

//components
import { BottomNavigation } from "../components/bottomNavi"
import { RecordListView, MonthlySummaryPanel } from '../components/mainPageComponents';
import { MonthPickerComponent, } from '../components/buttons/DataMonthManager';
import { Constants } from '../common/Constants';
import { resourceManager } from '@kit.LocalizationKit';
import { formatDateAdvanced } from '../utils/formatDateAdvanced';

// æ¥å—åºåˆ—åŒ–å¤±è´¥çš„å›è°ƒ
PersistenceV2.notifyOnError((key: string, reason: string, msg: string) => {
  console.error(`error key: ${key}, reason: ${reason}, message: ${msg}`);
});


@Entry
@Preview
@ComponentV2
struct Index {
  @Local weeklyData: number[] = [];
  @Local currentTabIndex: number = 0
  @Local
  recordsData: RecordsData = PersistenceV2.connect(
    RecordsData,
    'incomeExpenseRecords',
    () => new RecordsData()
  )!;
  @Local
  choosedData: RecordsData = PersistenceV2.connect(
    RecordsData,
    'choosedRecords',
    () => new RecordsData()
  )!;

  @Monitor('choosedData.items')
  onItemsChange(monitor: IMonitor) {
    console.log("Items changed");
    this.UpdateThings()
  }

  private async UpdateThings() {
    this.weeklyData = await calculateWeeklyData(this.recordsData.items, this.userSetting.preferredCurrency)
  }

  @Local
  userSetting: UserSetting = PersistenceV2.connect(// æœ¬åœ°æŒä¹…åŒ–ç”¨æˆ·è®¾ç½®
    UserSetting,
    "userSetting",
    () => new UserSetting()
  )!;

  aboutToAppear(): void {
    this.UpdateThings()
    console.log(new Date().toDateString());
    console.log(formatDateAdvanced(new Date(), "DD"));

  }

  onPageShow(): void {
    this.UpdateThings()
  }

  @Local
  tempMessage: string = ""

  private async fetchRate() {
    this.tempMessage = "çº¦ä¸º" + this.userSetting.preferredCurrency +
    (await calculateTotalAssets(this.choosedData.items, this.userSetting.preferredCurrency)).toFixed(2).toString()
  }

  //SideBar
  @Local active: number = 0;
  @Local show: boolean = false;
  @Local menuItems: string[] = [
    'è´§å¸è®¾ç½®',
    'åˆ é™¤è®°å½•',
    'éšç§æ”¿ç­–',
  ];

  handleMenuItemClick(item: string) {
    switch (item) {
      case "è´§å¸è®¾ç½®":
        router.pushUrl({
          url: "pages/CurrencySetting"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        console.log('æ‰§è¡Œè´§å¸è®¾ç½®');
        break;
      case "åˆ é™¤è®°å½•":
        AlertDialog.show({
          title: `è¦åˆ é™¤è®°å½•å—`,
          message: `æ­¤æ“ä½œä¸å¯é€€å›`,
          buttons: [
            {
              value: 'å–æ¶ˆ',
              action: () => {
              }
            },
            {
              value: 'ç¡®è®¤',
              action: () => {
                this.recordsData.items = []
                this.choosedData.items = []
                console.log('æ‰§è¡Œåˆ é™¤æ“ä½œ');
              }
            },
          ]
        })

        break;

      case "éšç§æ”¿ç­–":
        router.pushUrl({
          url: "pages/AboutThisApp"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        break;
      // å…¶ä»–case...
    }
  }

  private getMenuItemIcon(item: string): string {
    const iconMap: Record<string, string> = {
      'è´§å¸è®¾ç½®': 'ï¸ğŸ’´',
      'åˆ é™¤è®°å½•': 'ğŸ—‘ï¸',
      'åˆ†äº«è®°å½•': 'â†—ï¸',
      'éšç§æ”¿ç­–': 'ğŸ”’',
      'è®¾ç½®': 'âš™ï¸',
      'å¸®åŠ©': 'â“',
      'å…³äºåº”ç”¨': 'â„¹ï¸'
    };
    return iconMap[item] || 'â–ªï¸'; // é»˜è®¤ç¬¦å·
  }

  build() {

    SideBarContainer(SideBarContainerType.Overlay) {

      //è¾¹æ å†…å®¹
      Column() {

        List() {
          ListItem() {
            //è¾¹æ èœå•
            Column() {
              Row() {
                Image($r('app.media.right_arrow'))
                  .width(24)
                  .height(25)
                  .onClick(() => {
                    this.show = false
                    this.getUIContext().animateTo({
                      duration: Constants.ANIMATION_DURATION,
                      curve: Curve.EaseOut,
                      playMode: PlayMode.Normal,
                    }, () => {
                    })
                  })
              }.width("90%").margin({ bottom: 14 }).justifyContent(FlexAlign.Start)


              Column().height(250).width("100%").backgroundColor(Color.Gray)
                .margin({ bottom: 14 })

              ratesStatus()

              ForEach(this.menuItems, (item: string, index: number) => {
                Column() {
                  Row() {
                    // å›¾æ ‡ï¼ˆä½¿ç”¨Unicodeç¬¦å·ï¼‰
                    Text(this.getMenuItemIcon(item))
                      .fontSize(20)
                      .margin({ right: 12 })
                      .fontColor('#007AFF')
                    // æ–‡å­—
                    Text(item)
                      .fontSize(16)
                      .layoutWeight(1)
                    // ç®­å¤´ï¼ˆUnicodeç¬¦å·ï¼‰
                    if (index < this.menuItems.length - 1) {
                      Text('â¯')
                        .fontSize(14)
                        .fontColor('#999999')
                    }
                  }
                  .height(48)
                  .width('100%')
                  .padding({ left: 16, right: 16 })
                  .onClick(() => {
                    this.handleMenuItemClick(item);

                    this.show = !this.show
                    this.getUIContext().animateTo({
                      duration: Constants.ANIMATION_DURATION,
                      curve: Curve.EaseOut,
                      playMode: PlayMode.Normal,
                    }, () => {
                      // åŠ¨ç”»å®Œæˆåçš„å›è°ƒ
                    })
                  })

                  if (index < this.menuItems.length - 1) {
                    Divider()
                      .strokeWidth(1)
                      .color('#F0F0F0')
                      .margin({ left: 24, right: 46 }) // ä¸å›¾æ ‡å¯¹é½
                  }
                }
              })
            }
            .borderRadius(8)
            .clip(true)
          }
        }
        .sticky(StickyStyle.Header)
        .scrollBar(BarState.Off)
        .listDirection(Axis.Vertical)
        .edgeEffect(EdgeEffect.Spring)
        .height("100%")

      }
      .alignItems(HorizontalAlign.Start)
      .padding({ top: 14 })
      .backgroundColor($r("app.color.Basic_Card_background"))
      .width(272)
      .height(344)
      .borderRadius(20)

      //ä¸»è¦å†…å®¹
      Column() {
        Stack({ alignContent: Alignment.Bottom }) {
          Tabs({ barPosition: BarPosition.End }) {
            TabContent() {

              List() {
                ListItem() {

                  Column({ space: 2 }) {

                    //é¡¶æ 
                    Row() {


                      MonthPickerComponent()
                      //æŠ½å±‰å¼€å…³
                      Button({ type: ButtonType.Circle, stateEffect: true }) {
                        Image($r('app.media.moreMenu')).width(35).height(35).align(Alignment.Center)
                      }
                      .backgroundColor($r('app.color.Basic_Card_background'))
                      .width(40)
                      .height(40)
                      .onClick(() => {

                        this.show = !this.show
                        this.getUIContext().animateTo({
                          duration: Constants.ANIMATION_DURATION,
                          curve: Curve.EaseOut,
                          playMode: PlayMode.Normal,
                        }, () => {
                          // åŠ¨ç”»å®Œæˆåçš„å›è°ƒ
                        })
                      })
                    }
                    .justifyContent(FlexAlign.SpaceBetween)
                    .width("90%")
                    .margin({ bottom: 18 })
                    .height(40)


                    //########
                    MonthlySummaryPanel({ recordList: this.choosedData.items })
                    WeeklyChart({ data: this.weeklyData })

                    RecordListView({ recordList: this.choosedData.items })

                  }.padding(12)
                }
              }
              .sticky(StickyStyle.Header)
              .scrollBar(BarState.Off)
              .listDirection(Axis.Vertical)
              .edgeEffect(EdgeEffect.Spring)
              .height("100%")

            }.tabBar('é¦–é¡µ')


            TabContent() {
              List() {
                ListItem() {
                  Column({ space: 2 }) {


                    MultiCurrencyComposition({ recordList: this.recordsData.items })
                  }
                }.padding(10)
              }
              .sticky(StickyStyle.Header)
              .scrollBar(BarState.Off)
              .listDirection(Axis.Vertical)
              .edgeEffect(EdgeEffect.Spring)
              .height("100%")

            }.tabBar('æˆ‘çš„')
          }

          // BottomNavigation()
          Image($r('app.media.add'))
            .width(80)
            .height(80)
            .onClick(() => {
              router.pushUrl({
                url: "pages/AddRecordPage"
              }, router.RouterMode.Standard, (err) => {
                if (err) {
                  console.log("è·³è½¬å¤±è´¥:", err)
                }
              })
            })
            .backgroundColor(Color.White)
            .borderRadius(66)


        }.height("100%")

      }
      .onClick(() => {
        this.getUIContext().animateTo({
          duration: Constants.ANIMATION_DURATION,
          curve: Curve.EaseOut,
          playMode: PlayMode.Normal,
        }, () => {
          this.show = false;
        })
      })
      .width('100%')
      .height('110%')

    }
    .sideBarPosition(SideBarPosition.End)
    .showSideBar(this.show)
    .showControlButton(false)

    .onChange((value: boolean) => {
      this.show = value;
    })
    .backgroundColor($r("app.color.start_window_background"))
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])

  }
}