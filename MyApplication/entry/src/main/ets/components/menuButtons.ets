//from system
import { PersistenceV2, promptAction, router } from '@kit.ArkUI';
import i18n from '@ohos.i18n'

//from myself
import { calculateTotalAssets, } from "../utils/moneyCount"
import { RecordItem, RecordsData, LedgerManager, LedgerBook } from '../models/recordItemReference';
import { UserSetting } from "../models/userSetting"
import { ratesStatus } from "../components/RatesStatus"
import { exporter } from "../utils/cloudAndFiles/csvExporter"
import { cloudData } from "../utils/cloudAndFiles/cloud"

//components
import { BottomNavigation } from "../components/bottomNavi"
import { RecordListView, MonthlySummaryPanel } from '../components/mainPageComponents';

import { budgetComponent } from '../components/bugetComponent';
import { searchBarView } from '../components/searchBar';
import { datePicker } from '../components/buttons/MonthPicker';
import { Constants } from '../common/Constants';
import { resourceManager } from '@kit.LocalizationKit';
import { formatDateAdvanced } from '../utils/formatDateAdvanced';
import { filePicker } from "../utils/cloudAndFiles/importFromLocal"

@Styles
function buttonList() {
  .backgroundColor($r('app.color.Basic_Card_background'))
  .padding(6)
  .width('90%')
  .borderRadius(14)
  .margin({ bottom: 12 })
}

@Styles
function buttonItemStyle() {
  .backgroundColor($r('app.color.Basic_Card_background'))
  .padding(6)
  .width('90%')
  .borderRadius(14)
  .margin({ bottom: 12 })
}

@Styles
function basicCard() {
  .width('100%')
  .padding(16)
  .borderRadius(15)
  .margin({ bottom: 12 })
  .backgroundColor($r("app.color.Basic_Card_background"))
}


@Entry
@ComponentV2
export struct menuButtons {
  build() {
    Column() {

      LedgerUI()
      functionButtons1()
      functionButtons2()
      ratesStatus().margin({ bottom: 16 })
    }

  }
}

@ComponentV2
export struct menuList {
  @Local
  ledgerManager: LedgerManager = PersistenceV2.connect(
    LedgerManager,
    'multiLedgerStorage',
    () => new LedgerManager()
  )!;
  @Local recordsData: RecordsData = this.ledgerManager.activeBook.data
  @Local menuItems: string[] = [
    'è´§å¸è®¾ç½®',
    'éšç§æ”¿ç­–',
    'è´§å¸è®¾ç½®',
    'éšç§æ”¿ç­–',
    'è´§å¸è®¾ç½®',
    'éšç§æ”¿ç­–',
    'è´§å¸è®¾ç½®',
    'éšç§æ”¿ç­–',
    'è´§å¸è®¾ç½®',
    'éšç§æ”¿ç­–',
  ];

  handleMenuItemClick(item: string) {
    switch (item) {
      case "è´§å¸è®¾ç½®":
        router.pushUrl({
          url: "pages/CurrencySetting"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        console.log('æ‰§è¡Œè´§å¸è®¾ç½®');
        break;

      case "éšç§æ”¿ç­–":
        router.pushUrl({
          url: "pages/AboutThisApp"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        break;
      // å…¶ä»–case...
    }
  }

  private getMenuItemIcon(item: string): string {
    const iconMap: Record<string, string> = {
      'è´§å¸è®¾ç½®': 'ï¸ğŸ’´',
      'åˆ é™¤è®°å½•': 'ğŸ—‘ï¸',
      'åˆ†äº«è®°å½•': 'â†—ï¸',
      'éšç§æ”¿ç­–': 'ğŸ”’',
      'è®¾ç½®': 'âš™ï¸',
      'å¸®åŠ©': 'â“',
      'å…³äºåº”ç”¨': 'â„¹ï¸'
    };
    return iconMap[item] || 'â–ªï¸'; // é»˜è®¤ç¬¦å·
  }

  build() {
    Column() {
      List() {
        ListItemGroup() {

          ForEach(this.menuItems, (item: string, index: number) => {
            ListItem() {
              Column() {
                // å›¾æ ‡ï¼ˆä½¿ç”¨Unicodeç¬¦å·ï¼‰
                Text(this.getMenuItemIcon(item))
                  .fontSize(20)
                  .fontColor('#007AFF')
                // æ–‡å­—
                Text(item)
                  .fontSize(12)
                  .margin({ top: 4 })
              }
              .width('20%')
              .padding({ left: 12, right: 12 })
              .onClick(() => {
                this.handleMenuItemClick(item);

                this.getUIContext().animateTo({
                  duration: Constants.ANIMATION_DURATION,
                  curve: Curve.EaseOut,
                  playMode: PlayMode.Normal,
                }, () => {
                  // åŠ¨ç”»å®Œæˆåçš„å›è°ƒ
                })
              })
            }
          })
        }
      }
      .sticky(StickyStyle.Header)
      .scrollBar(BarState.Off)
      .listDirection(Axis.Horizontal)
      .edgeEffect(EdgeEffect.Spring)

    }.basicCard()
  }
}

@ComponentV2
export struct functionButtons1 {
  @Local
  ledgerManager: LedgerManager = PersistenceV2.connect(
    LedgerManager,
    'multiLedgerStorage',
    () => new LedgerManager()
  )!;
  @Local recordsData: RecordsData = this.ledgerManager.activeBook.data
  @Local menuItems: string[] = [
    'è´§å¸è®¾ç½®',
    'åº”ç”¨è®¾ç½®',
    'éšç§æ”¿ç­–',
  ];

  handleMenuItemClick(item: string) {
    switch (item) {
      case "è´§å¸è®¾ç½®":
        router.pushUrl({
          url: "pages/CurrencySetting"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        console.log('æ‰§è¡Œè´§å¸è®¾ç½®');
        break;

      case "éšç§æ”¿ç­–":
        router.pushUrl({
          url: "pages/AboutThisApp"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        break;
      case "åº”ç”¨è®¾ç½®":
        router.pushUrl({
          url: "pages/appSetting"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        break;

      // å…¶ä»–case...
    }
  }

  private getMenuItemIcon(item: string): string {
    const iconMap: Record<string, string> = {
      'è´§å¸è®¾ç½®': 'ï¸ğŸ’´',
      'éšç§æ”¿ç­–': 'â„¹ï¸',
      'åº”ç”¨è®¾ç½®': 'âš™ï¸',
      'å¸®åŠ©': 'â“',
      'å…³äºåº”ç”¨': 'â„¹ï¸'
    };
    return iconMap[item] || 'â–ªï¸'; // é»˜è®¤ç¬¦å·
  }

  build() {
    Column() {
      ForEach(this.menuItems, (item: string, index: number) => {
        Column() {
          Row() {

            // å›¾æ ‡ï¼ˆä½¿ç”¨Unicodeç¬¦å·ï¼‰
            Text(this.getMenuItemIcon(item))
              .fontSize(20)
              .margin({ right: 12 })
              .fontColor('#007AFF')
            // æ–‡å­—
            Text(item)
              .fontSize(16)
              .layoutWeight(1)
          }
          .height(48)
          .width('100%')
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            this.handleMenuItemClick(item);

            this.getUIContext().animateTo({
              duration: Constants.ANIMATION_DURATION,
              curve: Curve.EaseOut,
              playMode: PlayMode.Normal,
            }, () => {
              // åŠ¨ç”»å®Œæˆåçš„å›è°ƒ
            })
          })

          if (index < this.menuItems.length - 1) {
            Divider()
              .strokeWidth(1)
              .color('#F0F0F0')
              .margin({ left: 24, right: 46 }) // ä¸å›¾æ ‡å¯¹é½
          }
        }
      })
    }
    .buttonList()

  }
}

@ComponentV2
export struct functionButtons2 {
  @Local
  ledgerManager: LedgerManager = PersistenceV2.connect(
    LedgerManager,
    'multiLedgerStorage',
    () => new LedgerManager()
  )!;
  @Local recordsData: RecordsData = this.ledgerManager.activeBook.data
  @Local menuItems: string[] = [
    'å¯¼å…¥è®°å½•',
    'å¯¼å‡ºè´¦æœ¬',
    'ä¸Šä¼ åˆ°äº‘ç«¯',
    'ä»äº‘ç«¯ä¸‹è½½',
  ];

  handleMenuItemClick(item: string) {
    switch (item) {

      case "å¯¼å‡ºè´¦æœ¬":
        const ex = new exporter
        ex.exportAndShare()
        break;

      case "ä¸Šä¼ åˆ°äº‘ç«¯":
        const cloud = new cloudData
        cloud.askToUpsert()
        break;
      case "å¯¼å…¥è®°å½•":
        //
        const picker = new filePicker
        picker.importCsv()
        break;
      case "ä»äº‘ç«¯ä¸‹è½½":
        router.pushUrl({
          url: "pages/cloudDownload"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        break;
      case "éšç§æ”¿ç­–":
        router.pushUrl({
          url: "pages/AboutThisApp"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
        break;


      // å…¶ä»–case...
    }
  }

  private getMenuItemIcon(item: string): string {
    const iconMap: Record<string, string> = {
      'å¯¼å‡ºè´¦æœ¬': 'ğŸ“¤',
      'å¯¼å…¥è®°å½•': 'ğŸ“¥',
      'ä»äº‘ç«¯ä¸‹è½½': 'â˜ï¸ â¬‡',
      'ä¸Šä¼ åˆ°äº‘ç«¯': 'â˜ï¸ â¬†',


    };
    return iconMap[item] || 'â–ªï¸'; // é»˜è®¤ç¬¦å·
  }

  build() {
    Column() {

      ForEach(this.menuItems, (item: string, index: number) => {
        Column() {
          Row() {
            // å›¾æ ‡ï¼ˆä½¿ç”¨Unicodeç¬¦å·ï¼‰
            Text(this.getMenuItemIcon(item))
              .fontSize(20)
              .margin({ right: 12 })
              .fontColor('#007AFF')
            // æ–‡å­—
            Text(item)
              .fontSize(16)
              .layoutWeight(1)

          }
          .height(48)
          .width('100%')
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            this.handleMenuItemClick(item);

            this.getUIContext().animateTo({
              duration: Constants.ANIMATION_DURATION,
              curve: Curve.EaseOut,
              playMode: PlayMode.Normal,
            }, () => {
              // åŠ¨ç”»å®Œæˆåçš„å›è°ƒ
            })
          })

          if (index < this.menuItems.length - 1) {
            Divider()
              .strokeWidth(1)
              .color('#F0F0F0')
              .margin({ left: 24, right: 46 }) // ä¸å›¾æ ‡å¯¹é½
          }
        }
      })

    }
    .buttonList()

  }
}

// ChooseLedgerBooks UI.ets
@ComponentV2
export struct LedgerUI {
  @Local
  ledgerManager: LedgerManager = PersistenceV2.connect(
    LedgerManager,
    'multiLedgerStorage',
    () => new LedgerManager()
  )!;
  @Local recordsData: RecordsData = this.ledgerManager.activeBook.data
  @Local newBookName: string = '';

  build() {
    Column({ space: 8 }) {
      Row() {
        Text('è´¦æœ¬é€‰æ‹© ' + this.ledgerManager.books.length + "/3")
        Text('â¯')
          .fontSize(14)
          .fontColor('#999999')
      }.justifyContent(FlexAlign.SpaceBetween).width('95%')
      .onClick(() => {
        router.pushUrl({
          url: "pages/AddLegerBookPage"
        }, router.RouterMode.Standard, (err) => {
          if (err) {
            console.log("è·³è½¬å¤±è´¥:", err)
          }
        })
      })

      ForEach(this.ledgerManager.books, (book: LedgerBook) => {

        Text(book.name)
          .onClick(() => {
            this.ledgerManager.switchBook(book.id);
            this.recordsData = this.ledgerManager.activeBook.data;
          })
          .backgroundColor(book.id === this.ledgerManager.activeBookId ? $r('app.color.Currency_Card_Main') :
            $r('app.color.Currency_Card_1'))
          .width("90%")
          .textAlign(TextAlign.Center)
          .padding(8)
          .borderRadius(28)
          .shadow(ShadowStyle.OUTER_DEFAULT_XS)

      })


    }
    .buttonList()
    .padding(12)
  }
}
