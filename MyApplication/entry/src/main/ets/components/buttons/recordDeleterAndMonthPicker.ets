import { RecordItem, RecordsData, filterRecordItems } from "../../models/recordItemReference"
import { PersistenceV2, promptAction, router } from '@kit.ArkUI';
import { TipsDialog } from '@kit.ArkUI'
import { emitter, Callback } from '@kit.BasicServicesKit';


@ComponentV2
export struct recordDeleter {
  @Local
  recordsData: RecordsData = PersistenceV2.connect(
    RecordsData,
    'incomeExpenseRecords',
    () => new RecordsData()
  )!;
  @Local
  choosedData: RecordsData = PersistenceV2.connect(
    RecordsData,
    'choosedRecords',
    () => new RecordsData()
  )!;

  public deleteDataFromAll(item: RecordItem) {

    if (!this.recordsData) {
      promptAction.showToast({ message: 'æ•°æ®è¿žæŽ¥å¤±è´¥ï¼Œæ— æ³•åˆ é™¤è®°å½•' });
      return;
    }

    const index = this.recordsData.items.findIndex(record =>
    record.id === item.id
    );

    if (index !== -1) {
      if (this.recordsData) {
        this.recordsData.items = this.recordsData.items.filter((item, i) => i !== index);
      }
      // filter
    } else {
      promptAction.showToast({ message: 'æœªæ‰¾åˆ°æŒ‡å®šè®°å½•ï¼Œæ— æ³•åˆ é™¤' });
    }
  }

  build() {

  }
}

@Entry
@ComponentV2
export struct datePicker {
  private select: number | number[] = 0;

  generateYears(start: number, end: number): string[] {
    let years: string[] = [];
    for (let i = start; i <= end; i++) {
      years.push(`${i}å¹´`);
    }
    return years;
  }

  private fruits: string[][] = [
    this.generateYears(2000, 2030),
    ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ']
  ];
  @Local selectedDate: Date = new Date();
  @Local recordsData: RecordsData = PersistenceV2.connect(
    RecordsData,
    'incomeExpenseRecords',
    () => new RecordsData()
  )!;
  @Local choosedData: RecordsData = PersistenceV2.connect(
    RecordsData,
    'choosedRecords',
    () => new RecordsData()
  )!;
  @Local now: Date = new Date();

  @Monitor('recordsData.items')
  onItemsChange(monitor: IMonitor) {
    console.log("DataFilteredByMonth");
    this.filterRecords();
  }

  onPageShow(): void {
    this.filterRecords();
  }

  private getMonthRange(date: Date): [Date, Date] {
    const startDate = new Date(date.getFullYear(), date.getMonth(), 1);
    const endDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    return [startDate, endDate];
  }

  private filterRecords() {
    const result: Date[] = this.getMonthRange(this.selectedDate);
    const startDate: Date = result[0]
    const endDate: Date = result[1]
    this.choosedData.items = filterRecordItems(this.recordsData.items, startDate, endDate);
  }

  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const monthNames =
      ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
    const month = monthNames[date.getMonth()];
    return `${year}å¹´${month}`;
  }

  build() {
    Text(this.formatDate(this.selectedDate) + "ðŸ‘‡").fontSize(28)
      .fontWeight(FontWeight.Bold)
      .onClick(() => {
        const currentYear = this.now.getFullYear();
        const currentMonth = this.now.getMonth();

        const yearList = this.generateYears(2000, 2030);
        const yearIndex = yearList.indexOf(`${currentYear}å¹´`);
        const monthIndex = currentMonth;

        this.select = [yearIndex, monthIndex];

        this.getUIContext().showTextPickerDialog({
          range: this.fruits,
          selected: this.select,
          value: this.formatDate(this.selectedDate),
          defaultPickerItemHeight: 40,

          onAccept: (value: TextPickerResult) => {
            this.select = value.index;
            const year: number = 2000 + value.index[0];
            const month: number = value.index[1];
            this.selectedDate = new Date(year, month, 1);
            this.filterRecords();
            console.info("TextPickerDialog:onAccept()" + JSON.stringify(value));
          }
        });
      });
  }
}
