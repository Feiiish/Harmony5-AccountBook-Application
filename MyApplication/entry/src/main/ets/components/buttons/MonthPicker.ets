import { RecordItem, RecordsData, filterRecordItems, LedgerManager } from "../../models/recordItemReference"
import { PersistenceV2, promptAction, router } from '@kit.ArkUI';
import { CachedRatesStatus, UserSetting } from "../../models/userSetting"
import { TipsDialog } from '@kit.ArkUI'
import { emitter, Callback } from '@kit.BasicServicesKit';

@Entry
@ComponentV2
export struct datePicker {
  private select: number | number[] = 0;
  @Local
  ledgerManager: LedgerManager = PersistenceV2.connect(
    LedgerManager,
    'multiLedgerStorage',
    () => new LedgerManager()
  )!;

  generateYears(start: number, end: number): string[] {
    let years: string[] = [];
    for (let i = start; i <= end; i++) {
      years.push(`${i}å¹´`);
    }
    return years;
  }

  private fruits: string[][] = [
    this.generateYears(2000, 2030),
    ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ']
  ];
  @Local selectedDate: Date = new Date();
  @Local tomonthRecords: RecordsData = PersistenceV2.connect(
    RecordsData,
    'tomonthRecords',
    () => new RecordsData()
  )!;
  @Local now: Date = new Date();

  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const monthNames =
      ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
    const month = monthNames[date.getMonth()];
    return `${year}å¹´${month}`;
  }

  build() {
    Text(this.formatDate(this.ledgerManager.activeBook.chosenDate) + "ðŸ‘‡").fontSize(28)
      .fontWeight(FontWeight.Bold)
      .onClick(() => {
        const currentYear = this.now.getFullYear();
        const currentMonth = this.now.getMonth();

        const yearList = this.generateYears(2000, 2030);
        const yearIndex = yearList.indexOf(`${currentYear}å¹´`);
        const monthIndex = currentMonth;

        this.select = [yearIndex, monthIndex];

        this.getUIContext().showTextPickerDialog({
          range: this.fruits,
          selected: this.select,
          value: this.formatDate(this.selectedDate),
          defaultPickerItemHeight: 40,

          onAccept: (value: TextPickerResult) => {
            this.select = value.index;
            const year: number = 2000 + value.index[0];
            const month: number = value.index[1];
            this.ledgerManager.activeBook.chosenDate = new Date(year, month, 1);
            console.info("TextPickerDialog:onAccept()" + JSON.stringify(value));
          }
        });
      });
  }
}
